{% extends "base.html" %}

{% block title %}Wishlist{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Wishlist</h1>
        
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" id="search-input" class="form-control" placeholder="Search MusicBrainz for albums...">
                    <button id="search-musicbrainz" class="btn btn-primary">Search</button>
                </div>
            </div>
            <div class="col-md-4">
                <button id="auto-update-btn" class="btn btn-success">Auto-Update</button>
                <button id="refresh-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div id="search-results" style="display: none;" class="mb-4">
            <h5>Search Results</h5>
            <div id="search-results-content"></div>
        </div>
        
        <div id="loading" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <div id="wishlist-content">
            <!-- Wishlist will be populated here -->
        </div>
    </div>
</div>

<!-- Toast container for notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-message">
            <!-- Message will be populated here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadWishlist() {
    const loading = document.getElementById('loading');
    const content = document.getElementById('wishlist-content');
    
    loading.style.display = 'block';
    content.innerHTML = '';
    
    fetch('/api/wishlist')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.error) {
                content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.albums.length === 0) {
                content.innerHTML = '<div class="alert alert-info">Your wishlist is empty.</div>';
                return;
            }
            
            // Create list format
            let html = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Wishlist Albums</h5>
                        <small class="text-muted">
                            Total: ${data.albums.length} albums 
                            (${data.albums.filter(a => !a.auto_added).length} manual, 
                             ${data.albums.filter(a => a.auto_added).length} auto-added)
                        </small>
                    </div>
                    <div class="list-group list-group-flush">
            `;
            
            data.albums.forEach((album, index) => {
                const isOdd = index % 2 === 1;
                const autoType = album.auto_added ? 
                    '<span class="badge bg-secondary me-2">AUTO</span>' : 
                    '<span class="badge bg-primary me-2">MANUAL</span>';
                
                // Format release date if available
                let releaseInfo = '';
                console.log(album)
                if (album.release_date) {
                    releaseInfo = ` <small class="text-success">(${album.release_date})</small>`;
                } else if (album.release_year) {
                    releaseInfo = ` <small class="text-success">(${album.release_year})</small>`;
                }
                
                html += `
                    <div class="list-group-item ${isOdd ? 'list-group-item-light' : ''}">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${autoType}<strong>${escapeHtml(album.artist)}</strong> - ${escapeHtml(album.title)}${releaseInfo}
                                </h6>
                                <small class="text-muted">
                                    Added: ${album.added_date} â€¢ MB ID: ${album.mb_id}
                                </small>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-danger btn-sm me-1" onclick="removeFromWishlist('${album.mb_id}')" title="Remove from wishlist">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                                <button class="btn btn-info btn-sm" onclick="showAlbumDetails('${album.mb_id}')" title="View details">
                                    <i class="bi bi-info-circle"></i> Info
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        })
        .catch(error => {
            loading.style.display = 'none';
            content.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        });
}

function searchMusicBrainz() {
    const searchTerm = document.getElementById('search-input').value.trim();
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');
    
    if (!searchTerm) {
        showToast('Please enter a search term', 'warning');
        return;
    }
    
    searchResultsContent.innerHTML = '<div class="spinner-border" role="status"></div>';
    searchResults.style.display = 'block';
    
    fetch('/api/wishlist/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ search: searchTerm })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            searchResultsContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (data.albums.length === 0) {
            searchResultsContent.innerHTML = '<div class="alert alert-info">No albums found.</div>';
            return;
        }
        
        // Create list for search results
        let html = `
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Search Results</h6>
                </div>
                <div class="list-group list-group-flush">
        `;
        
        data.albums.forEach((album, index) => {
            const isOdd = index % 2 === 1;
            html += `
                <div class="list-group-item ${isOdd ? 'list-group-item-light' : ''}">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <strong>${escapeHtml(album.artist)}</strong> - ${escapeHtml(album.title)}
                            </h6>
                            <small class="text-muted">Release Date: ${album.date}</small>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-success btn-sm" onclick="addToWishlist('${album.mb_id}', '${escapeHtml(album.artist)}', '${escapeHtml(album.title)}', '${album.date}')">
                                <i class="bi bi-plus-circle"></i> Add to Wishlist
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        searchResultsContent.innerHTML = html;
    })
    .catch(error => {
        searchResultsContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}

function addToWishlist(mbId, artist, title, releaseDate = '') {
    fetch('/api/wishlist/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mb_id: mbId,
            artist: artist,
            title: title,
            release_date: releaseDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, 'danger');
        } else {
            showToast(data.message, 'success');
            loadWishlist();
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('search-input').value = '';
        }
    })
    .catch(error => {
        showToast('Error adding to wishlist: ' + error.message, 'danger');
    });
}

function removeFromWishlist(mbId) {
    if (!confirm('Are you sure you want to remove this album from your wishlist?')) {
        return;
    }
    
    fetch('/api/wishlist/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ mb_id: mbId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, 'danger');
        } else {
            showToast(data.message, 'success');
            loadWishlist();
        }
    })
    .catch(error => {
        showToast('Error removing from wishlist: ' + error.message, 'danger');
    });
}

function showAlbumDetails(mbId) {
    const url = `https://musicbrainz.org/release/${mbId}`;
    window.open(url, '_blank');
}

function autoUpdate() {
    const btn = document.getElementById('auto-update-btn');
    const originalText = btn.textContent;
    
    btn.disabled = true;
    btn.textContent = 'Updating...';
    
    fetch('/api/wishlist/auto-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.textContent = originalText;
        
        if (data.error) {
            showToast(data.error, 'danger');
        } else {
            showToast(data.message, 'success');
            if (data.added_count > 0) {
                loadWishlist();
            }
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.textContent = originalText;
        showToast('Error during auto-update: ' + error.message, 'danger');
    });
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('notification-toast');
    const toastMessage = document.getElementById('toast-message');
    
    // Set message and style
    toastMessage.textContent = message;
    toast.className = `toast show bg-${type}`;
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event listeners
document.getElementById('search-musicbrainz').addEventListener('click', searchMusicBrainz);
document.getElementById('auto-update-btn').addEventListener('click', autoUpdate);
document.getElementById('refresh-btn').addEventListener('click', loadWishlist);

document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchMusicBrainz();
    }
});

// Load initial data
loadWishlist();
</script>
{% endblock %}
